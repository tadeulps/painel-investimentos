<section class="simulacao-page">
  <app-page-header 
    title="Simulador de Investimentos" 
    subtitle="Simule seu investimento e veja o retorno esperado mês a mês">
  </app-page-header>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <p>Carregando produtos...</p>
  </div>

  <!-- Step 1: Product Selection (if no productId) -->
  <div *ngIf="!selectedProduct && !isLoading" class="product-selection-section">
    <h2 class="section-title">Selecione um Produto</h2>
    
    <div class="carousel-container">
      <button 
        class="carousel-btn prev" 
        (click)="previousProduct()" 
        [disabled]="currentProductIndex === 0"
        aria-label="Produto anterior">
        ←
      </button>

      <div class="carousel-track">
        <mat-card 
          *ngFor="let product of availableProducts; let i = index" 
          class="product-card-mini"
          [class.active]="i === currentProductIndex"
          [class.prev]="i < currentProductIndex"
          [class.next]="i > currentProductIndex"
          (click)="selectProduct(product)">
          
          <mat-card-header>
            <mat-chip [class]="'chip-' + getRiskClass(product.risco)">{{ product.tipo }}</mat-chip>
          </mat-card-header>
          
          <mat-card-content>
            <h3>{{ product.nome }}</h3>
            
            <div class="product-info">
              <div class="info-item">
                <span class="label">Rentabilidade:</span>
                <span class="value">{{ (product.taxaAnual * 100).toFixed(2) }}%</span>
              </div>
              <div class="info-item">
                <span class="label">Risco:</span>
                <span class="value risk" [class]="'risk-' + getRiskClass(product.risco)">
                  {{ product.risco }}
                </span>
              </div>
            </div>
          </mat-card-content>

          <mat-card-actions>
            <button mat-raised-button color="primary" (click)="selectProduct(product)">
              <mat-icon>check_circle</mat-icon> Selecionar
            </button>
          </mat-card-actions>
        </mat-card>
      </div>

      <button 
        class="carousel-btn next" 
        (click)="nextProduct()" 
        [disabled]="currentProductIndex === availableProducts.length - 1"
        aria-label="Próximo produto">
        →
      </button>
    </div>

    <div class="carousel-dots">
      <span 
        *ngFor="let product of availableProducts; let i = index" 
        class="dot" 
        [class.active]="i === currentProductIndex"
        (click)="goToProduct(i)">
      </span>
    </div>
  </div>

  <!-- Step 2: Simulation Form (after product selected) -->
  <div *ngIf="selectedProduct" class="simulation-form-section">
    <mat-card class="selected-product-card">
      <mat-card-header>
        <mat-card-title>Produto Selecionado</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="product-banner">
          <span class="product-name">{{ selectedProduct.nome }}</span>
          <span class="product-rent">{{ (selectedProduct.taxaAnual * 100).toFixed(2) }}% a.a.</span>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="changeProduct()">
          <mat-icon>swap_horiz</mat-icon> Trocar Produto
        </button>
      </mat-card-actions>
    </mat-card>

    <h2 class="section-title">Dados da Simulação</h2>

    <mat-card class="form-card">
      <form [formGroup]="simulationForm" (ngSubmit)="simulate()">
        <mat-form-field appearance="outline">
          <mat-label>Valor do Investimento (R$)</mat-label>
          <input 
            matInput 
            type="number" 
            formControlName="valor"
            placeholder="Ex: 10000"
            min="100"
            step="100">
          <mat-icon matPrefix>attach_money</mat-icon>
          <mat-error *ngIf="simulationForm.get('valor')?.invalid">
            Valor mínimo de R$ 100,00
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Prazo (meses)</mat-label>
          <input 
            matInput 
            type="number" 
            formControlName="prazoMeses"
            placeholder="Ex: 12"
            min="1"
            max="360"
            step="1">
          <mat-icon matPrefix>schedule</mat-icon>
          <mat-error *ngIf="simulationForm.get('prazoMeses')?.invalid">
            Prazo entre 1 e 360 meses
          </mat-error>
        </mat-form-field>

        <button 
          mat-raised-button 
          color="primary"
          type="submit"
          [disabled]="simulationForm.invalid">
          <mat-icon>calculate</mat-icon> Simular Investimento
        </button>
      </form>
    </mat-card>
  </div>

  <!-- Step 3: Simulation Results -->
  <div *ngIf="simulationResult" class="simulation-results-section">
    <h2 class="section-title">Resultado da Simulação</h2>

    <div class="results-summary">
      <mat-card class="summary-card">
        <mat-card-content>
          <span class="label">Valor Inicial</span>
          <span class="value">{{ simulationResult.valorInicial | currency:'BRL' }}</span>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card highlight">
        <mat-card-content>
          <span class="label">Valor Final</span>
          <span class="value">{{ simulationResult.valorFinal | currency:'BRL' }}</span>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card">
        <mat-card-content>
          <span class="label">Rendimento Total</span>
          <span class="value gain">{{ simulationResult.rendimentoTotal | currency:'BRL' }}</span>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card">
        <mat-card-content>
          <span class="label">Prazo</span>
          <span class="value">{{ simulationResult.prazoMeses }} meses</span>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card class="monthly-breakdown">
      <mat-card-header>
        <mat-card-title>Evolução Mensal</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="simulationResult.detalheMensal" class="monthly-table">
          <ng-container matColumnDef="mes">
            <th mat-header-cell *matHeaderCellDef>Mês</th>
            <td mat-cell *matCellDef="let month">{{ month.mes }}</td>
          </ng-container>

          <ng-container matColumnDef="saldo">
            <th mat-header-cell *matHeaderCellDef>Saldo</th>
            <td mat-cell *matCellDef="let month">{{ month.saldo | currency:'BRL' }}</td>
          </ng-container>

          <ng-container matColumnDef="rendimento">
            <th mat-header-cell *matHeaderCellDef>Rendimento</th>
            <td mat-cell *matCellDef="let month" class="gain">{{ month.rendimento | currency:'BRL' }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['mes', 'saldo', 'rendimento']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['mes', 'saldo', 'rendimento']"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <div class="actions">
      <button mat-button (click)="newSimulation()">
        <mat-icon>refresh</mat-icon> Nova Simulação
      </button>
      <button 
        mat-raised-button 
        color="accent"
        (click)="proceedToInvest()"
        [disabled]="isInvesting">
        <mat-icon>{{ isInvesting ? 'hourglass_empty' : 'trending_up' }}</mat-icon>
        {{ isInvesting ? 'Processando...' : 'Investir Agora' }}
      </button>
    </div>
  </div>
</section>
