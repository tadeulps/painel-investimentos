<section class="simulacao-page" role="main">
  <app-page-header
    title="Simulador de Investimentos"
    subtitle="Simule seu investimento e veja o retorno esperado mês a mês"
  >
  </app-page-header>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container" role="status" aria-live="polite">
    <p>Carregando produtos...</p>
  </div>

  <!-- Step 1: Product Selection (if no productId) -->
  <div *ngIf="!selectedProduct && !isLoading" class="product-selection-section">
    <h2 class="section-title">Selecione um Produto</h2>

    <div class="carousel-container">
      <button
        class="carousel-btn prev"
        (click)="previousProduct()"
        [disabled]="currentProductIndex === 0"
        aria-label="Produto anterior"
      >
        <mat-icon>chevron_left</mat-icon>
      </button>

      <div class="carousel-track">
        <mat-card
          *ngFor="let product of availableProducts; let i = index"
          class="product-card-mini"
          [class.active]="i === currentProductIndex"
          [class.prev]="i === currentProductIndex - 1"
          [class.next]="i === currentProductIndex + 1"
          [class.hidden]="
            i < currentProductIndex - 1 || i > currentProductIndex + 1
          "
          (click)="selectProduct(product)"
        >
          <mat-card-content>
            <div class="card-header-custom">
              <h3 class="product-name">{{ product.nome }}</h3>
              <div
                class="risk-icon"
                [class]="'risk-icon-' + getRiskClass(product.risco)"
              >
                <mat-icon aria-hidden="true">{{ getRiskIcon(product.risco) }}</mat-icon>
              </div>
            </div>

            <div class="product-details">
              <div class="detail-item">
                <span class="label">Tipo</span>
                <span class="value">{{ product.tipo }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Rentabilidade</span>
                <span class="value rentabilidade">
                  <mat-icon class="trending-icon" aria-hidden="true">trending_up</mat-icon>
                  {{ (product.taxaAnual * 100).toFixed(2) }}% a.a.
                </span>
              </div>
              <div class="detail-item">
                <span class="label">Risco</span>
                <mat-chip [class]="'risk-' + getRiskClass(product.risco)">{{
                  product.risco
                }}</mat-chip>
              </div>
            </div>
          </mat-card-content>

          <mat-card-actions>
            <app-caixa-button
              variant="secondary"
              [fullWidth]="true"
              icon="check_circle"
              (clicked)="selectProduct(product)"
            >
              Selecionar
            </app-caixa-button>
          </mat-card-actions>
        </mat-card>
      </div>

      <button
        class="carousel-btn next"
        (click)="nextProduct()"
        [disabled]="currentProductIndex === availableProducts.length - 1"
        aria-label="Próximo produto"
      >
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <div class="carousel-dots">
      <span
        *ngFor="let product of availableProducts; let i = index"
        class="dot"
        [class.active]="i === currentProductIndex"
        (click)="goToProduct(i)"
      >
      </span>
    </div>
  </div>

  <!-- Step 2: Simulation Form (after product selected) -->
  <div *ngIf="selectedProduct" class="simulation-form-section">
    <mat-card class="selected-product-card">
     
      <mat-card-content>
        <div class="product-banner">
          <span class="product-name">{{ selectedProduct.nome }}</span>
          <span class="product-rent"
            >{{ (selectedProduct.taxaAnual * 100).toFixed(2) }}% a.a.</span
          >
        </div>
      </mat-card-content>
      <mat-card-actions>
        <app-caixa-button
          variant="secondary"
          [fullWidth]="true"
          (clicked)="changeProduct()"
        >
          <mat-icon>swap_horiz</mat-icon> Trocar Produto
        </app-caixa-button>
      </mat-card-actions>
    </mat-card>

    <h2 class="section-title">Dados da Simulação</h2>

    <mat-card class="form-card">
      <form [formGroup]="simulationForm" (ngSubmit)="$event.preventDefault()">
        <mat-form-field appearance="outline">
          <mat-label>Valor do Investimento (R$)</mat-label>
          <input
            matInput
            type="number"
            formControlName="valor"
            placeholder="Ex: 10000"
            min="100"
            step="100"
          />
          <mat-icon matPrefix>attach_money</mat-icon>
          <mat-error *ngIf="simulationForm.get('valor')?.invalid">
            Valor mínimo de R$ 100,00
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Prazo (meses)</mat-label>
          <input
            matInput
            type="number"
            formControlName="prazoMeses"
            placeholder="Ex: 12"
            min="1"
            max="360"
            step="1"
          />
          <mat-icon matPrefix>schedule</mat-icon>
          <mat-error *ngIf="simulationForm.get('prazoMeses')?.invalid">
            Prazo entre 1 e 360 meses
          </mat-error>
        </mat-form-field>

        <app-caixa-button
          variant="secondary"
          [fullWidth]="true"
          icon="calculate"
          [disabled]="simulationForm.invalid"
          (clicked)="simulate()"
        >
          Simular Investimento
        </app-caixa-button>
      </form>
    </mat-card>
  </div>

  <!-- Step 3: Simulation Results -->
  <div *ngIf="simulationResult" class="simulation-results-section">
    <h2 class="section-title">Resultado da Simulação</h2>

    <div class="results-summary">
      <mat-card class="summary-card">
        <mat-card-content>
          <h3 class="label">Valor Inicial</h3>
          <p class="value">{{
            simulationResult.valorInicial | currency : "BRL"
          }}</p>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card highlight">
        <mat-card-content>
          <h3 class="label">Valor Final</h3>
          <p class="value">{{
            simulationResult.valorFinal | currency : "BRL"
          }}</p>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card">
        <mat-card-content>
          <h3 class="label">Rendimento Total</h3>
          <p class="value gain">{{
            simulationResult.rendimentoTotal | currency : "BRL"
          }}</p>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card">
        <mat-card-content>
          <h3 class="label">Prazo</h3>
          <p class="value">{{ simulationResult.prazoMeses }} meses</p>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card class="monthly-breakdown">
      <mat-card-header>
        <mat-card-title>Evolução Mensal</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table
          mat-table
          [dataSource]="displayedMonths"
          class="monthly-table"
        >
          <ng-container matColumnDef="mes">
            <th mat-header-cell *matHeaderCellDef>Mês</th>
            <td mat-cell *matCellDef="let month">
              <span *ngIf="!isSeparatorRow(month)">{{ month.mes }}</span>
              <span *ngIf="isSeparatorRow(month)" class="separator-dots">...</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="saldo">
            <th mat-header-cell *matHeaderCellDef>Saldo</th>
            <td mat-cell *matCellDef="let month">
              <span *ngIf="!isSeparatorRow(month)">{{ month.saldo | currency : "BRL" }}</span>
              <span *ngIf="isSeparatorRow(month)" class="separator-text">
                {{ month.hiddenCount }} {{ month.hiddenCount === 1 ? 'mês' : 'meses' }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="rendimento">
            <th mat-header-cell *matHeaderCellDef>Rendimento</th>
            <td mat-cell *matCellDef="let month" [class.gain]="!isSeparatorRow(month)">
              <span *ngIf="!isSeparatorRow(month)">{{ month.rendimento | currency : "BRL" }}</span>
              <span *ngIf="isSeparatorRow(month)" class="separator-dots">...</span>
            </td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="['mes', 'saldo', 'rendimento']"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['mes', 'saldo', 'rendimento']"
            [class.separator-row]="isSeparatorRow(row)"
          ></tr>
        </table>

        <div *ngIf="shouldShowExpandButton" class="expand-button-container">
          <app-caixa-button
            variant="secondary"
            icon="expand_more"
            (clicked)="toggleShowAllMonths()"
          >
            Exibir todos os meses ({{ hiddenMonthsCount }} ocultos)
          </app-caixa-button>
        </div>

        <div *ngIf="showAllMonths && simulationResult && simulationResult.detalheMensal.length > 20" class="collapse-button-container">
          <app-caixa-button
            variant="outlined"
            icon="expand_less"
            (clicked)="toggleShowAllMonths()"
          >
            Recolher
          </app-caixa-button>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="actions">
      <app-caixa-button
        variant="primary"
        icon="refresh"
        (clicked)="newSimulation()"
      >
        Nova Simulação
      </app-caixa-button>
      <app-caixa-button
        variant="secondary"
        [icon]="isInvesting ? 'hourglass_empty' : 'trending_up'"
        [disabled]="isInvesting"
        [attr.role]="isInvesting ? 'status' : null"
        (clicked)="proceedToInvest()"
      >
        {{ isInvesting ? "Processando..." : "Investir Agora" }}
      </app-caixa-button>
    </div>
  </div>
</section>
